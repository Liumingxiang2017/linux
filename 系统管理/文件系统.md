# 文件系统

文件系统(File System) ：层次化管理机制 倒置的树状目录结构

文件由inode和block组成，inode包括文件名称、大小、属性、权限、指针。

文件有两类数据：

1. 元数据：metadata
2. 数据：data

文件命名规则：

- 文件名严格区分大小写；
- 文件名可以使用/以外的任意字符，，不建议使用特殊字符； /：表示根目录，路径分隔符；
- 文件名长度不能超过255个字符；
- .开头文件为隐藏文件；

路径：

1. 绝对路径：从根目录起始的路径；
2. 相对路径：从当前位置起始的路径；

当前路径：current directory, 也称为working directory

./ 当前目录；../ 当前目录的上一级目录

查看当前路径：pwd: printing working directory;

LSB: Linux Standard Base linux标准库决定了有哪些文件夹

文件系统块组(ext2)组成：
超级块、GDT、block bitmap、inode bitmap、data blocks

## 文件系统类型

ext3: RHEL5

ext4：多了日志，RHEL6使用

XFS: 分区更多达到18EB，RHEL7使用

cat /proc/filesystems :查看当前内核所支持文件系统类型

### VFS 虚拟文件系统

计算机具有多种文件系统，Linux内核中的软件层为用户程序提供了VFS(Virtual File System)接口，这样实际上操作文件就是统一对这个虚拟文件系统进行操作。

## FHS 文件系统层次化结构

rootfs: 根文件系统

FHS：Linux文件系统标准

    中文名 文件系统层次化标准 

    外文名 Filesystem Hierarchy Standard 

    结构类型 树形结构组织文件 

### 重要目录

- /boot: 系统启动相关的文件，如内核、initrd，以及grub(bootloader)
- /dev: device设备文件  一切皆文件
  - 设备文件：
    - 块设备：随机访问，数据块
    - 字符设备：线性访问，按字符为单位逐个访问  显示器，鼠标都是字符设备
    - 两个数字是设备号：设备号（major）和次设备号（minor）
    - 特殊文件是没有大小的，没有数据只有元数据，作为设备访问入口存在的
- /etc：配置文件
- /home：用户的家目录，每一个用户的家目录通常默认为/home/USERNAME
- /root：管理员的家目录
- /lib：库文件和内核模块文件
  - 静态库,  .a（linux）
  - 动态库， .dll（windows里）, .so (shared object共享对象，linux里)
  - /lib/modules：内核模块文件
- /media：挂载点目录，移动设备比如U盘光盘   挂载：将某个目录同设备相关联
- /mnt：挂载点目录，额外的临时文件系统比如第二块硬盘
- /opt：可选目录，早起通常用于第三方程序的安装目录 如Nessus
  - 现在约定熟成一般放在/usr/local
- /proc：伪（虚拟）文件系统，事实上目录中没有任何内容，内核映射文件
  - 内核可调参数，内核统计数据，网卡统计数据,ipv4协议，可以改变操作系统根本工作属性
- /sys：伪文件系统，跟硬件设备相关的属性映射文件，内核相关，磁盘相关
- /tmp：临时文件, /var/tmp
- /var：variable 可变化的文件
  - /var/mail 用户邮件转存位置
  - /var/log 日志文件
  - /var/run 进程运行有进程号，.pid进程id
  - /var/tmp 临时文件目录
  - /var/www apache的文档目录
  - /var/lib 系统运行时随时改变的库文件
  - /var/local /var/local程序的可变数据
  - /var/spool 邮件，新闻等队列的脱机目录
- /bin: binary 可执行文件, 用户命令
- /sbin：super binary 管理命令
- /misc 杂项，一般很少用
- /usr：univers全局的 shared共享的, read-only只读的 文件
  - /usr/bin 几乎所有命令程序
  - /usr/sbin 系统管理的命令程序
  - /usr/lib
  - /usr/share 帮助与说明文件，共享文件
  - /usr/src/linux-version/  linux源代码
- /bin /sbin 自身启动相关命令  /usr/bin /usr/sbin 系统启动后为了提供基本功能的命令
- /usr/local 用户自行安装的本地软件
  - /usr/local/bin
  - /usr/local/sbin
  - /usr/local/lib


## 创建文件系统（格式化）

存储设备使用步骤

1. 分区
fdisk
2. 创建文件系统（格式化）
mkfs.ext4
mkfs.xfs
3. 挂载
mount,永久生效需要写入/etc/fstab

真机验证再次分区,如果增加新分区，则不影响原有内容；如果改变原有分区，则原来内容会消失。不过最好还是备份。

重新分区需要先卸载分区，否则显示繁忙。 partprobe命令未必有用。

当/etc/fstab有误，开机时会卡在命令行界面，输入root密码，修正/etc/fstab后重启就行。

案例:普通分区

```shell
# 查看硬盘是否已经存在
fdisk -l 
# 查看是否已经有分区文件
ls /dev/sdb*
# 分区
fdisk /dev/sdb
# 格式化
mkfs.ext4 /dev/sdb1
# 挂载
mount /dev/sdb1 /www
vi /etc/fstab
# /dev/sdb1 /www ext4 defaults 0 0
#再次分区，先卸载，再重复上述操作
umount /dev/sdb1
```

案例：swap分区

```shell
# 分区
fdisk /dev/sdb
# 格式化
mkswap /dev/sdb2
# 挂载
swapon /dev/sdb2
vi /etc/fstab
# /dev/sdb2 swap swap 0 0
# 查看swap分区
free -m
```

fdisk

- -l 查看系统硬盘

### df 查看挂载信息

report file system disk space usage 报告文件系统磁盘空间使用情况

- df -h 以人类可读的方式显示所有挂在情况
- df -t ext3 查看所有类型为ext3的文件系统
- -T 类型, df -T，查看文件或目录所属的文件系统，是常用命令 
- -H 优化单位

### 使用mkfs创建文件系统

1. mkfs -t fstype partition
2. mkfs.fstype partition
3. mke2fs [-j] partition

### tune2fs
	-l
	-L
	-o

### dumpe2fs -h


安装RHEL6.3 x86_64的方法（前提：请确保你的CPU支持硬件虚拟化技术）：
1、创建虚拟机；
2、下载isos目录中的rhci-rhel-6.3-1.iso，并导入虚拟机的虚拟光驱；
3、在boot提示符输入：linux ip=172.16.x.1 netmask=255.255.0.0 gateway=172.16.0.1 dns=172.16.0.1 ks=http://172.16.0.1/rhel6.cfg

64, 32
/lib
/lib64

## 挂载mount

将设备与目录相关联，作用是让系统内能够使用硬盘资源。

文件系统挂载时的注意事项：

1. 挂载点事先存在；
2. 目录是否已经被其它进程使用；
3. 目录中的原有文件会被暂时隐藏；

/etc/fstab文件格式：
设备    挂载点  文件系统类型    挂载选项    转储频率  检测次序

mount DEVICE MOUNT_POINT

- 设备文件
- LABEL
- UUID
  - blkid 可以查看UUID

使用卷标挂载

```shell
#添加卷标 e2label
e2label device labelname
#根据卷标挂载
mount LABLE=labelname directory
#写入/etc/fstab
LABEL=labelname device fstype defaults 0 0
```

### 挂载外部存储设备

1. 挂载设备： mount 设备 挂载目录
    - df -T 检查是否挂载成功
2. 读写设备
3. 卸载设备： mount 挂载目录/设备
4. 拔掉设备:  umount device_or_directory

挂载目录最好是空目录，非空目录虽然也能挂载，但是其他内容在挂载后会消失。

### 挂载硬盘

硬盘是特殊的块设备，需要分区格式化后才能使用。

1. 分区
2. 格式化
3. 挂载分区
4. 读写挂载点
5. 写入/etc/fstab

### 挂载U盘

- U盘是USB设备，内置USB-SCSI转换接口，所以被认为是SCSI硬盘

- 需要事先驱动， # modprobe usb-storage

### 文件系统类型

- NTFS格式默认的内核不识别， mount -t ntfs /dev/hda3 /mnt/d

### 挂载选项

windows分区常用挂载选项，iocharset=\<charset\>

存在中文时，设置文件系统的字符编码常用值为gb2312和utf8

mount -t vfat -o iocharset=gb2312 /dev/hda3 /mnt/one

mount -t vfat -o utf8 /dev/hda3 /mnt/one

- -o uid=username,gid=gourpname 设置属主属组

- -o umask=0077 设置挂载点的文件权限掩码

| 挂载选项                |            含义             |
|-------------------------|:---------------------------:|
| ro/rw                   |          只读/读写          |
| exec/noexec             |       允许/不允许执行       |
| dev/nodev               |     允许/不允许设备文件     |
| suid,sgid/nosuid,nosgid |    允许/不允许suid,sgid     |
| atime,noatime           |  更新/不更新节点的访问时间  |
| async/sync              |      异步/同步磁盘I/O       |
| user/nouser             | 允许/不允许普通磁盘挂载磁盘 |


## 磁盘配额

- 限制普通用户使用的磁盘空间
- 只有ext2/ext3文件系统支持
- 需要quota软件包

磁盘配额配置过程

- 使用usrquota，grpquota选项配置一个分区，激活内核支持

mount -o usrquota,grpquota /dev/sdb1 /mnt/d1

mount -o remount,usrquota,grpquota /

- 永久支持需要编辑磁盘配置文件，/etc/fstab 将defaults后加入usrquota，grpquota

- init 1 （进入单用户环境，或者确定没有其他人使用也行）

- quotacheck -cvuga检查并且创建磁盘配额的数据库文件

- edquota -u username 为用户分配磁盘空间和节点数量

- quotaon 开启磁盘配额

- quota命令查看用户配额使用情况，或者repquota -a查看所有用户

- quotaoff 关闭磁盘配额

- 永久删除需要编辑/etc/fstab

- 删除磁盘配额数据库 quota.group quota.user


磁盘配额功能：限制普通用户使用的磁盘空间和创建文件的个数。

步骤（步骤1-4均为准备步骤）

1. 需要程序quota软件包

    - rpm -qa | grep quota

2. 使用userquota,grpquota选项挂载一个分区，激活内核支持。红帽67的xfs系统是uquota

    - mount -o userquota,grpquota /dev/sda2 /mnt/one

    - mount -o remount,usrquota,grpquota /dev/sda1 /  根目录重新挂载必须使用remount

    - 确保对应目录没有其他用户使用，或直接使用单用户模式init 1

    - 编辑/etc/fstab，自动挂载永久生效，注意备份并小心修改。

3. 检查创建磁盘配额数据库文件

    - quotacheck -cvug

        - -c 创建，-v过程可视化，-u用户，-g组

    - quotacheck -cvuga

        - -a表示所有/etc/fstab文件中含有usrquota,grpquota选项的磁盘都创建数据库文件

4. 开启

    - 激活全部 quotaon -a

    - 激活选定 quotaon /dev/sda2

5. 编辑

    - 编辑指定用户：edquota -u username

    - 编辑文件，只需要编辑soft，hard字段，其单位默认为K

    - 编辑grace宽限时间，默认时7天：edquota -t

6. 查看

    - 查看自己当前用户： quota

    - 管理员查看所有磁盘配额： repquota -a

7. 测试

    - dd if=/dev/zero of=filename bs=1k count=1024

8. 关闭

    - 管理员关闭所有配额： quotaoff /dev/sda2

案例 xfs系统磁盘配额

```shell
# -x 专家模式 -c 非交互模式设置
xfs_quota -x -c 'limit bsoft=3m bhard=5m isodft=3 ihard=6 linuxprobe' /boot
# 测试
chmod -Rf 777
su - linuxprobe
```

## ext2/ext3文件系统的优化和高级特性

mkfs.ext3 /dev/sdb1 格式化

mkfs.ext3 -b 4096 -i 4096 -m 2 /dev/sda2

- -m 保留块的百分比，默认为数据块的5%

tune2fs 调整ext2或者ext3文件系统特性

- -l 查看文件系统信息
- -c 设置强制自检的挂载次数
- -i 设置强制自检的间隔时间
- -m 保留块百分比
- -j 将ext2文件系统转化为ext3

### fsck 磁盘检查

fsck -t ext2 /dev/sdb1

fsck.ext3 /dev/sdb1


## 自动挂载分区
